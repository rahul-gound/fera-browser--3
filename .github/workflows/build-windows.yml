name: Build Fera-Search (Windows)

on:
  workflow_dispatch:
  push:
    branches: [ codex/fix-github-action-for-windows-artifac ]

jobs:
  win:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Prepare output folder
        shell: pwsh
        run: New-Item -ItemType Directory -Force download | Out-Null

      # Install MozillaBuild to C:\mozilla-build (what mach expects)
      - name: Install MozillaBuild
        shell: pwsh
        run: |
          $url = "https://ftp.mozilla.org/pub/mozilla/libraries/win32/MozillaBuildSetup-Latest.exe"
          $installer = "$env:TEMP\MozillaBuildSetup.exe"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process -FilePath $installer -ArgumentList "/S", "/D=C:\mozilla-build" -Wait
          if (!(Test-Path "C:\mozilla-build\start-shell.bat")) { throw "MozillaBuild install failed" }

      # Ensure mach sees it
      - name: Set MOZILLABUILD env
        shell: pwsh
        run: |
          echo "MOZILLABUILD=C:\mozilla-build" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # (Optional) Cache
      - name: Cache mozbuild state
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.mozbuild
            obj-*
          key: mozbuild-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            mozbuild-${{ runner.os }}-

      # Build (run inside MozillaBuild shell)
      - name: Build
        shell: cmd
        run: |
          C:\mozilla-build\start-shell.bat -no-interactive -here -c "cd /d %GITHUB_WORKSPACE% && ./mach --no-interactive build"

      # Package
      - name: Package
        shell: cmd
        run: |
          C:\mozilla-build\start-shell.bat -no-interactive -here -c "cd /d %GITHUB_WORKSPACE% && ./mach --no-interactive package"

      # Copy artifacts into download
      - name: Collect artifacts
        shell: pwsh
        run: |
          $distDirs = Get-ChildItem -Directory -Path "obj-*" -Filter "dist" -Recurse
          $seaDir = Get-ChildItem -Directory -Path "obj-*" -Recurse -Filter "sea" |
            Where-Object { $_.FullName -match "\\dist\\install\\sea$" } |
            Select-Object -First 1
          $searchPaths = @()
          if ($seaDir) { $searchPaths += $seaDir.FullName }
          if ($distDirs) { $searchPaths += $distDirs.FullName }
          if (-not $searchPaths) { throw "dist folder not found under obj-*." }
          $found = $false
          foreach ($path in $searchPaths) {
            $matches = Get-ChildItem -Path $path -Recurse -Include "*.exe","*.msi","*.zip" -File
            if ($matches) {
              $matches | Copy-Item -Destination "download" -Force
              $found = $true
            }
          }
          if (-not $found) { throw "No packaged artifacts found under obj-*/dist." }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fera-search-windows
          path: download/
